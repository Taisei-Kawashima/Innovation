<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>総合健康アプリ - ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Lucide icons for clean, modern look -->
    <script type="module">
        import { createIcons, Activity, Moon, Heart, TrendingUp, AlertTriangle, ChevronRight, CheckCircle } from 'https://unpkg.com/lucide@latest/dist/esm/lucide.js';
        document.addEventListener('DOMContentLoaded', () => {
          createIcons({
            icons: { Activity, Moon, Heart, TrendingUp, AlertTriangle, ChevronRight, CheckCircle }
          });
        });
    </script>
    <style>
        /* フォント設定と暖色系のカスタムカラー */
        :root {
            --color-primary: #FF7043; /* 暖色系のオレンジ */
            --color-secondary: #FFCC80; /* 明るいオレンジ */
            --color-background: #F8F4F2; /* 暖かなオフホワイト */
            --color-surface: #FFFFFF;
            --color-alert: #EF5350; /* 警告レッド */
            --color-safe: #66BB6A; /* 安全グリーン */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            /* body全体がコンテンツエリアとなる */
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        .header-content {
            padding: 16px 20px;
            background-color: var(--color-surface);
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 5;
        }
        .card {
            background-color: var(--color-surface);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 16px;
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #E64A19;
        }
        .gauge-ring {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            position: relative;
        }
        .gauge-svg {
            position: absolute;
            transform: rotate(-90deg);
        }
        /* コンテンツエリアのパディング */
        .app-content {
            padding: 16px; /* bodyのp-4をより標準的なパディングに変更 */
        }
    </style>
</head>
<body>

<!-- メインコンテンツエリア -->
<div class="app-content max-w-xl mx-auto">
    <!-- ヘッダー -->
    <div class="header-content mb-4">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-gray-800">Hello, ユーザー名 👋</h1>
            <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-sm font-semibold text-gray-600">
                <img src="https://placehold.co/40x40/FF7043/ffffff?text=U" alt="Profile" class="rounded-full">
            </div>
        </div>
        <!-- データ連携ステータス -->
        <div class="flex items-center text-sm text-gray-500 mb-2">
            <i data-lucide="check-circle" class="w-4 h-4 mr-1 text-green-500"></i>
            <span>Health Connectと連携済み</span>
        </div>
    </div>

    <!-- 1. 警告・アクションカード (独自性: 改善アドバイス) -->
    <div class="card bg-orange-50 border-l-4 border-[--color-alert]" id="alert-card">
        <div class="flex items-start">
            <i data-lucide="alert-triangle" class="w-6 h-6 mr-3 text-[--color-alert] mt-1"></i>
            <div>
                <h2 class="text-lg font-semibold text-gray-800 mb-1">【警告】睡眠負債が蓄積しています</h2>
                <p class="text-gray-600 text-sm">過去3日間の平均睡眠時間が目標より90分不足しています。このままでは集中力低下に繋がります。</p>
            </div>
        </div>
        <div class="mt-4 pt-3 border-t border-orange-200">
            <p class="text-sm font-semibold text-[--color-primary] flex justify-between items-center">
                今夜の目標：23:00就寝を目指しましょう
                <i data-lucide="chevron-right" class="w-4 h-4"></i>
            </p>
        </div>
    </div>

    <!-- 2. 健康スコア・行動サマリー (独自性: データ統合) -->
    <div class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4">総合健康スコア</h2>
        <div class="flex items-center justify-between">
            <!-- スコアのゲージ -->
            <div class="gauge-ring bg-gray-100">
                <svg class="gauge-svg" width="100" height="100" viewBox="0 0 100 100">
                    <!-- Background arc (Stroke-dasharray is used to simulate the gauge) -->
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#E0E0E0" stroke-width="8" />
                    <!-- Foreground arc (Simulate 75% score) -->
                    <circle id="gauge-arc" cx="50" cy="50" r="45" fill="none" stroke="var(--color-primary)" stroke-width="8"
                            stroke-dasharray="282.6" stroke-dashoffset="70.65" style="transition: stroke-dashoffset 0.5s ease;"/>
                </svg>
                <div class="text-3xl font-bold text-[--color-primary] z-10" id="score-value">75<span class="text-lg text-gray-600">/100</span></div>
            </div>
            <!-- 主要な指標 -->
            <div class="w-2/3 space-y-2">
                <div class="flex items-center justify-between">
                    <span class="flex items-center text-gray-600 text-sm"><i data-lucide="activity" class="w-4 h-4 mr-1 text-green-500"></i> 運動</span>
                    <span class="font-semibold text-gray-800" id="exercise-text">良好 (+5P)</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="flex items-center text-gray-600 text-sm"><i data-lucide="moon" class="w-4 h-4 mr-1 text-orange-500"></i> 睡眠</span>
                    <span class="font-semibold text-gray-800" id="sleep-text">要改善 (-10P)</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="flex items-center text-gray-600 text-sm"><i data-lucide="heart" class="w-4 h-4 mr-1 text-green-500"></i> 心拍数</span>
                    <span class="font-semibold text-gray-800" id="heart-text">安定 (+2P)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. 次の具体的なアクション (独自性: 行動変容) -->
    <div class="card">
        <h2 class="text-lg font-semibold text-gray-800 mb-3">今日のアクション</h2>
        <ul class="space-y-3">
            <!-- アクション項目 1 -->
            <li class="bg-blue-50 p-3 rounded-lg flex items-center justify-between shadow-sm">
                <div class="flex items-center">
                    <span class="inline-block w-2 h-2 rounded-full bg-blue-500 mr-2"></span>
                    <p class="text-sm font-medium text-gray-700">【運動】あと15分軽いウォーキング**をする</p>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-blue-500"></i>
            </li>
            <!-- アクション項目 2 -->
            <li class="bg-red-50 p-3 rounded-lg flex items-center justify-between shadow-sm">
                <div class="flex items-center">
                    <span class="inline-block w-2 h-2 rounded-full bg-red-500 mr-2"></span>
                    <p class="text-sm font-medium text-gray-700">【食事】夕食の塩分摂取量を1g減らす</p>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-red-500"></i>
            </li>
        </ul>
        <p class="text-xs text-gray-500 mt-4">※これらのアクションは、過去のデータと今日の活動状況に基づいて提案されています。</p>
    </div>

    <!-- 4. データ推移（グラフのプレースホルダー） -->
    <div class="card">
        <h2 class="text-lg font-semibold text-gray-800 mb-3">過去7日間の活動トレンド</h2>
        <div class="flex justify-between items-center text-sm text-gray-500 mb-3">
            <span>運動時間 (分)</span>
            <span class="text-green-600 flex items-center"><i data-lucide="trending-up" class="w-4 h-4 mr-1"></i> +15%</span>
        </div>
        <!-- グラフのプレースホルダー -->
        <div class="bg-gray-100 h-40 rounded-lg flex items-center justify-center text-gray-500 text-sm">
            <!-- 実際のアプリではここに動的なグラフ（例：D3.js）が表示されます -->
            グラフエリア（運動、睡眠などの推移を表示）
        </div>
    </div>

    <!-- 5. 低コストアピールカード -->
    <div class="card bg-[--color-primary] text-white">
        <h2 class="text-xl font-bold mb-2">低コストで、あなたの健康習慣をサポート。</h2>
        <p class="text-sm opacity-90">スマートウォッチは不要。他社に比べて年間で数万円の節約が可能です。</p>
        <button class="mt-4 bg-white text-[--color-primary] font-bold py-2 px-4 rounded-full text-sm shadow-md transition-transform transform hover:scale-[1.02]">
            年間コスト比較を見る
        </button>
    </div>

    <!-- 下部の余白 -->
    <div class="h-10"></div>
</div>

<script>
    // Expose updateHealthData for Kotlin evaluateJavascript to call
    window.updateHealthData = function(data) {
        try {
            if (typeof data === 'string') data = JSON.parse(data);
        } catch (e) {
            console.warn('updateHealthData: invalid payload', e);
            return;
        }

        console.log('updateHealthData called', data);

        const score = Number(data.exerciseScore ?? 0);
        const sleepHours = Number(data.sleepHours ?? 0);
        const steps = Number(data.steps ?? 0);
        const heartRate = Number(data.heartRate ?? 0);

        // Update gauge
        const gauge = document.querySelector('#gauge-arc');
        const scoreDisplay = document.getElementById('score-value');
        if (gauge) {
            const r = 45;
            const circumference = 2 * Math.PI * r;
            const offset = circumference * (1 - Math.max(0, Math.min(1, score / 100)));
            gauge.style.strokeDashoffset = offset;
        }
        if (scoreDisplay) {
            scoreDisplay.innerHTML = `${score}<span class="text-lg text-gray-600">/100</span>`;
        }

        // Update texts
        const exerciseText = document.getElementById('exercise-text');
        const sleepText = document.getElementById('sleep-text');
        const heartText = document.getElementById('heart-text');
        const alertCard = document.getElementById('alert-card');
        const sleepDeficit = document.getElementById('sleep-deficit');

        if (exerciseText) exerciseText.innerText = (score >= 70) ? `良好 (+${Math.round((score-70)/1)}P)` : `要改善 (${score}P)`;
        if (sleepText) sleepText.innerText = `${sleepHours}時間`;
        if (heartText) heartText.innerText = `${heartRate} bpm`;

        if (sleepHours < 7) {
            if (sleepDeficit) sleepDeficit.innerText = `${Math.round((7 - sleepHours) * 60)}分`;
            if (alertCard) alertCard.style.display = 'block';
        } else {
            if (alertCard) alertCard.style.display = 'none';
        }
    };

    // Expose a function to show connection status
    window.setHealthConnectStatus = function(connected) {
        const el = document.querySelector('.header-content .text-sm span') || document.getElementById('hc-status');
        if (el) {
            el.innerText = connected ? 'Health Connectと連携済み' : '未連携 - 設定から有効にしてください';
        }
        console.log('setHealthConnectStatus', connected);
    };

    // Keep existing initializeApp behavior for local debugging
    const fetchHealthData = async () => {
        console.log('Local fetchHealthData running (debug)');
        const score = 75;
        const gaugeCircle = document.querySelector('.gauge-svg circle:nth-child(2)');
        const scoreDisplay = document.querySelector('.gauge-ring > div');
        const circumference = 2 * Math.PI * 45;
        const offset = circumference - (score / 100) * circumference;
        if (gaugeCircle) gaugeCircle.style.strokeDashoffset = offset;
        if (scoreDisplay) scoreDisplay.innerHTML = `${score}<span class="text-lg text-gray-600">/100</span>`;
    };

    const initializeApp = () => {
        fetchHealthData();
    };

    document.addEventListener('DOMContentLoaded', () => {
        initializeApp();
        // Also set a visible initial status
        try { window.setHealthConnectStatus(false); } catch(e){}
    });
</script>

</body>
</html>
